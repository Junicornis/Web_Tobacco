# Unity 3D 安全培训系统技术方案设计文档

## 1. 项目概述

### 1.1 项目背景
本项目为安全培训系统，包含Web管理端和Unity 3D培训场景。用户在Web系统登录后，可进入Unity构建的3D场景进行沉浸式安全培训，培训过程中的答题记录、学习进度等数据需同步至Web系统。

### 1.2 核心需求
- Web系统具备用户登录、培训资料管理功能
- 点击"场景培训"启动Unity 3D培训场景
- Unity内置大模型问答和知识图谱功能
- 培训数据（答题记录、错误记录）统一存储
- 支持多用户在同一台电脑上快速切换

### 1.3 部署环境
- **网络环境**：内网环境（本地访问）
- **部署方式**：每台用户电脑独立安装（Node.js环境 + 浏览器访问）
- **操作系统**：Windows

---

## 2. 系统架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        单台用户电脑（Windows）                        │
│                                                                     │
│   ┌──────────────┐         HTTP          ┌───────────────────────┐ │
│   │   React前端   │◄─────────────────────►│    Node.js后端         │ │
│   │   (浏览器)    │                       │    localhost:3000     │ │
│   └──────────────┘                       │                       │ │
│          │                               │  ├─ 用户登录/Token管理 │ │
│          │ 点击"场景培训"                 │  ├─ MongoDB数据操作    │ │
│          │                               │  ├─ Neo4j代理查询      │ │
│          ▼                               │  └─ 大模型API代理      │ │
│   ┌──────────────┐                       └───────────┬───────────┘ │
│   │  启动Unity    │                                   │             │
│   │  读取token文件 │                                   │             │
│   └──────┬───────┘                                   │             │
│          │         HTTP (Bearer Token认证)           │             │
│          └───────────────────────────────────────────┘             │
│                                                      │              │
│   ┌──────────────┐    ┌──────────────┐    ┌────────┴──────────┐   │
│   │ Unity 3D培训  │    │   MongoDB    │    │      Neo4j        │   │
│   │   场景        │    │  localhost   │    │   localhost:7687  │   │
│   │               │    │  port 27017  │    │                   │   │
│   └──────────────┘    └──────────────┘    └───────────────────┘   │
│                                                              │      │
└──────────────────────────────────────────────────────────────┼──────┘
                                                               │
                                                    ┌──────────┴──────┐
                                                    │   外部大模型API   │
                                                    │  (OpenAI/文心等) │
                                                    │    【需联网】    │
                                                    └─────────────────┘
```

### 2.2 组件说明

| 组件 | 技术栈 | 职责 |
|------|--------|------|
| Web前端 | React | 用户界面、培训资料展示、启动培训入口 |
| Web后端 | Node.js + Express | 业务逻辑、数据接口、代理服务 |
| Unity客户端 | Unity 3D (Windows Standalone) | 3D培训场景、用户交互 |
| 数据库 | MongoDB | 用户数据、培训记录、答题记录 |
| 知识图谱 | Neo4j | 安全知识图谱存储与查询 |
| AI服务 | 外部API | 大模型问答能力 |

---

## 3. 关键技术方案

### 3.1 用户身份传递方案

由于Web系统与Unity以独立进程运行，采用**本地临时Token文件**方案实现身份传递：

```
┌─────────┐     登录成功      ┌─────────┐     生成Token      ┌──────────────┐
│  用户    │─────────────────►│ Node后端 │─────────────────►│ 内存存储Token │
└─────────┘                  └────┬────┘                  └──────────────┘
                                  │
                                  │ 点击"场景培训"
                                  ▼
                           ┌─────────────┐
                           │ 写入临时文件  │
                           │ temp_auth   │
                           │ {token,user}│
                           └──────┬──────┘
                                  │ 启动Unity
                                  ▼
                           ┌─────────────┐
                           │ Unity读取文件 │
                           │ 提取Token    │
                           └──────┬──────┘
                                  │ API请求携带Token
                                  ▼
                           ┌─────────────┐
                           │ Node验证Token │
                           │ 识别用户身份  │
                           └─────────────┘
```

**Token文件规范**：
- **文件路径**：`C:\SafetyTraining\temp\auth_token.json`
- **有效期**：5分钟（过期需重新登录）
- **文件权限**：当前用户只读，使用后立即删除
- **文件格式**：
  ```json
  {
    "token": "uuid-v4-token",
    "userId": "user_001",
    "username": "张三",
    "timestamp": 1707302400000,
    "expireAt": 1707302700000
  }
  ```

**多用户切换支持**：
每次点击"场景培训"时重新生成Token，与之前用户Token无关联，天然支持同一电脑多用户切换。

### 3.2 数据安全方案

#### 3.2.1 API密钥安全存储

| 密钥类型 | 存储位置 | 说明 |
|----------|----------|------|
| 大模型API Key | Node后端环境变量 | Unity不直接持有密钥 |
| MongoDB连接串 | Node后端配置文件 | 不暴露给客户端 |
| Neo4j密码 | Node后端配置文件 | Unity通过代理访问 |

#### 3.2.2 Unity数据访问方式

| 数据类型 | 访问方式 | 理由 |
|----------|----------|------|
| 培训记录/答题 | Unity → Node API → MongoDB | 统一权限控制，不暴露数据库 |
| 知识图谱查询 | Unity → Node API → Neo4j | 隔离直接访问，统一日志记录 |
| 大模型请求 | Unity → Node API → 外部API | 保护API密钥，统一计费管理 |

### 3.3 通信协议

采用**HTTP REST API**进行通信：

- **协议**：HTTP/1.1
- **数据格式**：JSON
- **认证方式**：Bearer Token (Authorization: Bearer {token})
- **基础URL**：`http://localhost:3000/api`

---

## 4. API接口设计

### 4.1 用户认证相关

| 接口 | 方法 | 说明 | 调用方 |
|------|------|------|--------|
| `/api/auth/login` | POST | 用户登录 | React |
| `/api/auth/token` | POST | 生成Unity临时Token | React |
| `/api/auth/verify` | GET | 验证Token有效性 | Unity |
| `/api/auth/logout` | POST | 退出登录 | React/Unity |

### 4.2 培训数据相关

| 接口 | 方法 | 说明 | 调用方 |
|------|------|------|--------|
| `/api/training/start` | POST | 开始培训记录 | Unity |
| `/api/training/answer` | POST | 提交答题记录 | Unity |
| `/api/training/progress` | PUT | 更新培训进度 | Unity |
| `/api/training/end` | POST | 结束培训 | Unity |
| `/api/training/history` | GET | 获取培训历史 | React |

### 4.3 AI与知识图谱代理

| 接口 | 方法 | 说明 | 调用方 |
|------|------|------|--------|
| `/api/llm/chat` | POST | 大模型对话 | Unity |
| `/api/kg/query` | POST | 知识图谱Cypher查询 | Unity |
| `/api/kg/search` | GET | 知识图谱关键词搜索 | Unity |

---

## 5. 数据流详细说明

### 5.1 启动培训流程

```
1. 用户在React页面点击"场景培训"按钮
   └─ React调用 POST /api/auth/token
      └─ Node生成Token，写入 C:\SafetyTraining\temp\auth_token.json
         └─ Node返回 {success: true}
            └─ React调用本地命令启动 Unity.exe
               └─ Unity启动后读取 token 文件
                  └─ Unity调用 GET /api/auth/verify 验证Token
                     └─ Token有效，建立用户上下文，进入培训场景
```

### 5.2 答题记录流程

```
1. 用户在Unity中完成答题
   └─ Unity调用 POST /api/training/answer
      Header: Authorization: Bearer {token}
      Body: {questionId, answer, isCorrect, timestamp}
      └─ Node验证Token，获取userId
         └─ Node写入 MongoDB
            └─ Node返回 {success: true}
               └─ Unity显示"记录已保存"
```

### 5.3 大模型问答流程

```
1. 用户在Unity中提问
   └─ Unity调用 POST /api/llm/chat
      Body: {question: "如何正确使用灭火器？", context: {...}}
      └─ Node接收请求，组装Prompt
         └─ Node调用外部大模型API（携带API Key）
            └─ 大模型返回回答
               └─ Node返回给Unity
                  └─ Unity展示回答内容
```

### 5.4 培训结束流程

```
1. 用户完成培训或点击退出
   └─ Unity调用 POST /api/training/end
      Body: {trainingId, duration, score, status}
      └─ Node更新培训记录状态为"已完成"
         └─ Node删除Token（可选）
            └─ Unity删除本地token文件
               └─ Unity进程退出
                  └─ React页面检测到Unity关闭，自动刷新显示培训结果
```

---

## 6. 数据库设计概要

### 6.1 MongoDB集合

| 集合名 | 说明 | 主要字段 |
|--------|------|----------|
| `users` | 用户信息 | userId, username, password, department |
| `training_records` | 培训记录 | recordId, userId, startTime, endTime, duration, score, status |
| `answer_records` | 答题记录 | answerId, recordId, userId, questionId, answer, isCorrect, timestamp |
| `temp_tokens` | 临时Token（内存/Redis亦可） | token, userId, createTime, expireTime |

### 6.2 Neo4j图数据模型

```cypher
// 示例：安全知识图谱节点和关系
(:SafetyKnowledge {id, title, category, content})
(:Operation {id, name, steps, warnings})
(:Equipment {id, name, type, location})

(:SafetyKnowledge)-[:APPLIES_TO]->(:Operation)
(:Operation)-[:USES]->(:Equipment)
(:Operation)-[:HAS_STEP]->(:Step)
```

---

## 7. 项目目录结构

```
Safety-Training/
├── web/                          # Web系统（React + Node）
│   ├── client/                   # React前端
│   │   ├── src/
│   │   ├── public/
│   │   └── package.json
│   ├── server/                   # Node后端
│   │   ├── src/
│   │   │   ├── routes/           # API路由
│   │   │   ├── controllers/      # 控制器
│   │   │   ├── models/           # 数据模型
│   │   │   ├── services/         # 业务逻辑
│   │   │   ├── middleware/       # 中间件（认证等）
│   │   │   └── utils/            # 工具函数
│   │   ├── config/               # 配置文件
│   │   └── package.json
│   └── README.md
├── unity/                        # Unity项目
│   ├── Assets/
│   │   ├── Scripts/
│   │   │   ├── Network/          # 网络请求模块
│   │   │   ├── Training/         # 培训逻辑
│   │   │   ├── AI/               # AI问答模块
│   │   │   └── Utils/            # 工具类
│   │   ├── Scenes/               # 场景文件
│   │   └── ...
│   └── ProjectSettings/
└── docs/                         # 文档
    └── 技术方案设计文档.md
```

---

## 8. 部署与运行流程

### 8.1 首次部署步骤

```bash
# 1. 安装依赖
## 安装Node.js环境（每台电脑）
## 安装MongoDB（本地，默认端口27017）
## 安装Neo4j（本地，默认端口7687/7474）

# 2. 部署Web系统
cd Safety-Training/web/server
npm install
## 配置环境变量（.env文件）
npm start

# 3. 构建Unity
cd Safety-Training/unity
## Unity Editor中构建Windows Standalone版本
## 将构建产物放置到指定目录

# 4. 配置Unity启动路径
## 修改React配置，指定Unity.exe路径
```

### 8.2 日常使用流程

```
1. 用户启动 MongoDB 服务
2. 用户启动 Neo4j 服务
3. 用户启动 Node后端 (npm start)
4. 用户打开浏览器访问 http://localhost:3000
5. 用户登录，进入培训系统
6. 用户点击"场景培训"，自动启动Unity
7. 培训完成后，Unity自动关闭，Web端显示结果
```

---

## 9. 安全注意事项

1. **Token文件权限**：确保token文件仅当前用户可读写，使用后立即删除
2. **API密钥管理**：严禁将大模型API Key提交到代码仓库
3. **内网环境限制**：虽然部署在内网，但仍需做好输入验证和权限控制
4. **Unity反编译风险**：敏感逻辑应放在Node端，Unity仅作为展示层

---
